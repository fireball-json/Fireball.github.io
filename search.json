[{"title":"ç§»åŠ¨ç«¯å¼€å‘é‡åˆ°çš„é—®é¢˜","url":"/2024/07/20/ç§»åŠ¨ç«¯å¼€å‘é‡åˆ°çš„é—®é¢˜/","content":" - [å®‰å“ä¿å­˜å›¾ç‰‡ä¹±åº](#title_1)\n - [IOSåˆ‡æ¢åº”ç”¨éŸ³é¢‘å¤±æ•ˆ](#title_2)\n\n<!-- more -->\n\n## <span id=\"title_1\" />1.å®‰å“ä¿å­˜å›¾ç‰‡ä¹±åº\n### é—®é¢˜æè¿°\nåœ¨ä¹‹å‰çš„å®‰å“å¼€å‘ä¸­ï¼Œç”¨æˆ·åé¦ˆè½¯ä»¶è½¯ä»¶ä¿å­˜çš„é¡ºåºæ··ä¹±(è¿™é‡Œéœ€è¦æä¸€ä¸‹ï¼Œè½¯ä»¶ä¿å­˜å›¾ç‰‡æ˜¯åœ¨**åŒä¸€æ—¶é—´ä¿å­˜å¤šå¼ ã€æœ‰é¡ºåºçš„å›¾ç‰‡**)ã€‚\n### è§£å†³æ–¹æ¡ˆ\nç»è¿‡æœ€åˆçš„å¤ç°ï¼Œå‘ç°å›¾ç‰‡çš„åç§°å‘½åä¸ºï¼šxxx_1ï¼Œä¼šäº§ç”Ÿï¼šxxx_1ï¼Œxxx_11ï¼Œ...ï¼Œxxx_2 è¿™æ ·çš„é¡ºåºã€‚\nä¿®æ”¹åç§°åˆ°æ–°çš„æ ¼å¼ï¼šxxx_001ï¼Œåœ¨æ‰‹æœºä¸Šä¿å­˜åå‡ å¼ å›¾ç‰‡ï¼Œå‘ç°é¡ºåºæ¢å¤æ­£å¸¸ï¼Œé‚è¿›è¡Œå…¶å®ƒçš„å·¥ä½œã€‚\n\nä½†æ˜¯è¿˜æ˜¯å¶å°”æœ‰ç”¨æˆ·åé¦ˆé¡ºåºæ··ä¹±ï¼Œé—®é¢˜å¹¶æ²¡æœ‰è§£å†³ã€‚ç»è¿‡è¯¦ç»†çš„æ£€æŸ¥ï¼Œå‘ç°æœ‰ä»¥ä¸‹é—®é¢˜ï¼š\n1. IOSç³»ç»Ÿå’Œæ¡Œé¢ç«¯ï¼Œé¡ºåºæ˜¯æ­£å¸¸çš„ï¼›\n2. å®‰å“æ‰‹æœºä¸­ï¼Œå›¾åº“çš„é¡ºåºéƒ½æœ‰é—®é¢˜ï¼›\n3. å®‰å“æ‰‹æœºä¸­ï¼Œä¿å­˜å›¾ç‰‡çš„æ–‡ä»¶å¤¹ä¸­ï¼Œåä¸ºçš„é¡ºåºæ˜¯æ­£å¸¸çš„ï¼Œå…¶å®ƒçš„æ··ä¹±ï¼›\n4. å•æ¬¡ä¿å­˜çš„å›¾ç‰‡é‡éœ€è¦æ¯”è¾ƒå¤§æ‰ä¼šå‡ºç°é—®é¢˜ï¼›\n\nç”±äºä»¥ä¸Šçš„åŸå› ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜å¶å°”æ‰åªæ˜¯å¶å°”å‡ºç°ã€‚æŸ¥è¯¢å›¾ç‰‡çš„å±æ€§ï¼Œå‘ç°åœ¨androidç³»ç»Ÿä¸­ï¼Œå›¾ç‰‡é»˜è®¤æ’åºæ˜¯**ä¿®æ”¹æ—¶é—´**æ’åºï¼›æ‰€ä»¥åœ¨åŸç”Ÿç«¯ä¸­ä½¿ç”¨Fileçš„`setLastModified`ä¿®æ”¹å›¾ç‰‡**ä¿®æ”¹æ—¶é—´**å±æ€§ã€‚ä¾æ¬¡å¢åŠ **1ms**ä¹‹åå´æ²¡æœ‰è§£å†³é—®é¢˜ï¼ŒæŸ¥è¯¢ç›¸å…³ä¿¡æ¯å¾—çŸ¥ï¼Œ**androidæœ€å°é—´éš”æ—¶é—´æ˜¯1ç§’**ï¼Œæ‰€ä»¥æœ€ç»ˆè§£å†³æ–¹æ¡ˆåªæ˜¯åœ¨ä¿å­˜å‡½æ•°è¿è¡Œçš„æ—¶å€™ï¼Œä¸ºæ¯ä¸€å¼ å›¾ç‰‡çš„**ä¿®æ”¹æ—¶é—´**ä¾æ¬¡å¢åŠ ä¸€ç§’ã€‚è¿™æ ·æˆ–è®¸ä¼šå¼•å‘å…¶å®ƒçš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™åªæ˜¯ä¸€ä¸ªæš‚æ—¶çš„è§£å†³æ–¹æ¡ˆã€‚\n\n## <span id=\"title_2\" />2.IOSåˆ‡æ¢åº”ç”¨éŸ³é¢‘å¤±æ•ˆ\n### é—®é¢˜æè¿°\nåœ¨IOSçš„å¼€å‘ä¸­ï¼Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå½“appåœ¨åå°åˆ‡æ¢ä¹‹åï¼Œå†æ¬¡è¿›å…¥ï¼ŒéŸ³é¢‘æ’­æ”¾ä¼šç›´æ¥å¤±æ•ˆï¼ŒsafariæŸ¥çœ‹æ§åˆ¶å°ï¼Œæœªè§æŠ¥é”™ã€‚\n### é—®é¢˜åˆ†æ\næŸ¥çœ‹ä»£ç å‘ç°ï¼Œåœ¨é¡¹ç›®ä¸­ï¼Œå¹¶ä¸æ˜¯ç›´æ¥åˆ›å»ºçš„`<audio>`æ ‡ç­¾è¿›è¡ŒéŸ³é¢‘æ’­æ”¾ï¼Œè€Œæ˜¯ä½¿ç”¨äº†`AudioContext`çš„å®ä¾‹ï¼Œè°ƒç”¨`decodeAudioData`è¯»å–bufferçš„ä¿¡æ¯ï¼ŒæŸ¥é˜…MDNæ–‡æ¡£è·å–äº†ä»¥ä¸‹ä¿¡æ¯(å°½é‡æŸ¥é˜…è‹±æ–‡ç‰ˆæœ¬çš„MDNæ–‡æ¡£)ï¼š\n##### 1.AudioContextå¯¹è±¡\n`AudioContext`æ˜¯ä¸€ä¸ªæœ‰éŸ³é¢‘æ¨¡å—é“¾æ¥æˆçš„å¤„ç†å›¾ï¼Œæ¯ä¸€ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ª`AudioNode`æ¨¡å—ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ª`AudioContext`å¯¹è±¡ï¼Œå³å¯åœ¨ä¸Šä¸‹æ–‡ä¸­å¤„ç†æ‰€æœ‰äº‹æƒ…ã€‚\n##### 2.å®ä¾‹æ–¹æ³•\n`AudioContext`ä¸ŠæŒ‚è½½äº†å¤šä¸ªå®ä¾‹æ–¹æ³•ï¼Œå¸¸ç”¨çš„ï¼š\n1. **close**ï¼šå…³é—­èŠ‚ç‚¹ï¼Œä½†æ˜¯åœ¨å…¶å®ƒå¼•ç”¨è§£é™¤ä¹‹å‰æ˜¯ä¸ä¼šé‡Šæ”¾å¯¹è±¡çš„ï¼Œåªæ˜¯ä¼šæš‚åœéŸ³é¢‘è¿›ç¨‹å’Œæš‚åœéŸ³é¢‘å¤„ç†ï¼›\n2. **suspend**ï¼šæš‚åœéŸ³é¢‘ä¸Šä¸‹æ–‡è¿›åº¦ï¼Œæš‚æ—¶å‰¥ç¦»å¯¹éŸ³é¢‘ç¡¬ä»¶è®¿é—®ã€‚å¯ä»¥å‡å°‘å¯¹cpuå’Œç”µæ± çš„ä½¿ç”¨ã€‚\n3. **resume**ï¼šæ¢å¤è¢«æš‚åœçš„éŸ³é¢‘ã€‚\n##### 3.éŸ³é¢‘çŠ¶æ€\néŸ³é¢‘çŠ¶æ€æœ‰ä¸‰ä¸ªï¼š**closed**ï¼Œ**suspend**ï¼Œ**running**ã€‚\nå¯¹åº”äº†ä¸Šè¿°å®ä¾‹æ–¹æ³•è°ƒç”¨ä¹‹åçš„çŠ¶æ€ï¼Œè°ƒç”¨`close`ä¹‹åï¼Œstateè½¬ä¸º**closed**çŠ¶æ€ï¼›åŒæ ·çš„ï¼Œè°ƒç”¨`suspend`åï¼ŒçŠ¶æ€è½¬ä¸º**suspended**çŠ¶æ€ï¼› å½“æ­£å¸¸æ’­æ”¾æ—¶ï¼Œåˆ™ä¸º**running**çŠ¶æ€ã€‚\n### é—®é¢˜ç¡®è®¤\nç°åœ¨å›åˆ°é—®é¢˜ï¼Œä¸ºä»€ä¹ˆåªåœ¨ioså‘ç”Ÿäº†è¿™ä¸ªé—®é¢˜å‘¢ï¼Œéœ€è¦å†æµ‹è¯•ä¸€ä¸‹ï¼š\næ‰“å¼€ä»£ç å‘ç°ï¼Œåˆ‡æ¢åå°è¿™ä¸ªåŠ¨ä½œåœ¨appå†…éƒ¨æ²¡æœ‰åšä»»ä½•åŠ¨ä½œï¼Œå³éŸ³é¢‘è¿˜æ˜¯åœ¨åå°ç»§ç»­æ’­æ”¾ï¼›ä½¿ç”¨çœŸæœºæµ‹è¯•åå‘ç°ï¼Œandroidåˆ‡æ¢åˆ°åå°ï¼ŒappéŸ³é¢‘ä»åœ¨æ’­æ”¾ï¼Œåˆ‡æ¢å›å»ä¹‹åï¼Œ**AudioContext.state**çš„çŠ¶æ€æ˜¯**running**ï¼Œé‚£ioså‘¢ï¼Œåˆ‡æ¢åå°ä¹‹åï¼ŒéŸ³é¢‘åœ¨æ’­æ”¾ï¼Œ**AudioContext.currentTime**æ˜¯åœ¨æ­£å¸¸æµåŠ¨çš„ï¼Œå¯æ˜¯æ²¡æœ‰å£°éŸ³ï¼ŒåŒæ—¶åˆ‡æ¢å›appä¹‹åï¼Œ**AudioContext.state**æ˜¯**interrupted**çŠ¶æ€...\næ­£åœ¨ç–‘æƒ‘çš„æ—¶å€™ï¼Œæˆ‘çªç„¶æƒ³åˆ°æŸ¥é˜…mdnæ–‡æ¡£ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œæœæ–­åˆ‡æ¢åˆ°è‹±æ–‡ä¹‹åï¼Œæ‰¾åˆ°äº†åŸå› ï¼š\n\n![MDN DOCS in English](../img/blog/mobile_1.png)\n\n### è§£å†³æ–¹æ¡ˆ\næŸ¥é˜…æ–‡æ¡£ä¹‹åï¼Œåœ¨ä¸å½±å“åŸæ¥çš„é€»è¾‘çš„æƒ…å†µä¸‹ï¼Œåœ¨ä»£ç ä¸­è¡¥å……äº†ä¸¤ä¸ªæ“ä½œï¼š\n    1. åˆ¤æ–­iosç¯å¢ƒï¼Œåœ¨åˆ‡æ¢åˆ°åå°ä¹‹åï¼Œæš‚åœæ’­æ”¾ï¼›\n    2. åˆ¤æ–­iosç¯å¢ƒï¼Œåœ¨æ’­æ”¾æ“ä½œè§¦å‘æ—¶ï¼Œåˆ¤æ–­çŠ¶æ€æ˜¯å¦æ˜¯**interrupted**ï¼Œè‹¥æ˜¯ï¼Œåˆ™è°ƒç”¨`resume`æ–¹æ³•ã€‚","tags":["Android IOS"]},{"title":"Webå¼€å‘é‡åˆ°çš„é—®é¢˜ï¼šResizeæ“ä½œ","url":"/2024/07/20/Webå¼€å‘é‡åˆ°çš„é—®é¢˜/","content":" - [Resize Obeserver](#title_1)\n - [clientHeight & getBoundingClientRect](#title_2)\n\n\n## <span id=\"title_1\" />1.Resize ObserveræŠ¥é”™\n### å‘ç°é—®é¢˜\nåœ¨ä¸€ä¸ªå¤šå±‚åµŒå¥—çš„ç»„ä»¶ä¸­ï¼Œæ§åˆ¶å°æ€»æ˜¯ä¼šæŠ¥é”™ä¸€ä¸ªerror: `ResizeObserver loop completed with undelivered notifications.`ï¼Œä½†æ˜¯ä¸å½±å“æ•´ä¸ªé¡¹ç›®çš„è¿è¡Œã€‚\n\n![console error](../img/blog/web_1.png)\n\nåœ¨googleæœç´¢ï¼ŒæŒ‡å‘è‹±æ–‡çš„MDNæ–‡æ¡£ï¼Œæœ‰å…·ä½“çš„è§£é‡Šï¼ˆæ‰€ä»¥ä¸€å®šåˆ‡è‹±æ–‡MDNæ–‡æ¡£æŸ¥èµ„æ–™ï¼‰ã€‚æ­£å¸¸çš„resizeäº‹ä»¶åº”å½“åœ¨ç»˜åˆ¶å‰è°ƒç”¨ï¼Œå½“resizeäº‹ä»¶è§¦å‘åï¼Œæ ·å¼é‡æ–°è¿›è¡Œè¯„ä¼°ï¼Œå¯ä¼šå¯¼è‡´æ›´å¤šçš„resizeäº‹ä»¶è§¦å‘ã€‚è€Œå›åˆ°è¿™æ¬¡é‡åˆ°é—®é¢˜çš„ç»„ä»¶ä¸­ï¼Œæˆ‘å‘ç°ï¼Œå½“ä¸Šå±‚ç»„ä»¶è°ƒæ•´å¤§å°åï¼Œåº•å±‚ç»„ä»¶é€šè¿‡ResizeObserverå›è°ƒï¼Œæ¥å®ç°è‡ªèº«è‡ªé€‚åº”çš„å¤§å°å˜æ¢ï¼Œè¿™ä¸ªè®¡ç®—é‡æ¯”è¾ƒå¤§ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰é™åˆ¶åœ¨ç»˜åˆ¶å‰è¿˜æ˜¯ç»˜åˆ¶åæ‰§è¡Œã€‚\n\n### åˆæ­¥è§£å†³\næ£€æŸ¥æ”¹å˜å…ƒç´ å¤§å°çš„ç›¸å…³ä»£ç ï¼Œå‘ç°æ˜¯ä½¿ç”¨æ‹–åŠ¨æ”¹å˜å…ƒç´ çš„ï¼Œæœ€å¼€å§‹è§‰å¾—æ˜¯åŒä¸€æ—¶é—´è§¦å‘çš„äº‹ä»¶å¤ªå¤šäº†ï¼Œè€Œæ¯æ¬¡è®¡ç®—æ—¶é—´åˆä¸é‚£ä¹ˆçŸ­ï¼Œæ‰€ä»¥å¯¼è‡´æ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶æ²¡æœ‰æ‰§è¡Œå®Œæˆå¯¼è‡´çš„ï¼Œåœ¨åŸåŸºç¡€ä¸Šä½¿ç”¨çš„setTimeoutè¿›è¡Œåˆ¶çº¦ï¼Œå‘ç°æ²¡æœ‰æŠ¥é”™äº†ï¼Œä½†æ˜¯æ‹–åŠ¨æ”¾å¤§çš„åŠ¨ç”»ä¸æ˜¯å¾ˆèˆ’æœï¼Œåç»­æ”¹ç”¨requestAnimationFrameä¹‹åï¼Œä½“éªŒå¢åŠ äº†ã€‚\n\n##### requestAnimationFrame\nè¿™æ˜¯ä¸€ä¸ªæŒ‚è½½åœ¨windowå¯¹è±¡ä¸‹çš„æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äºsetIntervalçš„api\n``` Javascript\nrequestAnimationFrame(callback)\nfunction callback(timestamp) {\n  // timestampæ˜¯æ¯ä¸€æ¬¡è°ƒç”¨å‡½æ•°çš„å¼€å§‹æ—¶é—´\n}\n```\nä¸setIntervalä¸åŒçš„æ˜¯ï¼Œå®ƒä¸æ˜¯ä¾ç…§æ—¶é—´è¿›è¡Œå›è°ƒçš„ï¼Œè€Œæ˜¯ä¾èµ–äºå±å¹•åˆ·æ–°ç‡ã€‚å½“æµè§ˆå™¨å‡†å¤‡æ¸²æŸ“ä¸‹ä¸€å¸§æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨callbackå›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯è¯¥å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶çš„å¼€å§‹æ—¶é—´ã€‚ä½¿ç”¨è¿™ä¸ªapiè¿›è¡ŒåŠ¨ç”»çš„æ¸²æŸ“ï¼Œä¼šéå¸¸çš„æµç•…ï¼Œä½†æ˜¯å› ä¸ºæ‰§è¡Œæ˜¯åŸºäºåˆ·æ–°ç‡ï¼Œåœ¨é«˜åˆ·æ–°ç‡æ—¶ï¼ŒåŠ¨ç”»æ‰§è¡Œé€Ÿåº¦ä¼šå¿«ä¸€äº›ï¼Œè¿™æ—¶å¯ä»¥ç”¨callbackå‡½æ•°çš„timestampå‚æ•°è¿›è¡ŒåŠ¨ç”»çš„è®¡ç®—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯**å›è°ƒå‡½æ•°æ€»æ˜¯åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“æ—¶è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶é—´å¹¶ä¸æ˜¯å½“å‰å¸§çš„æ—¶é—´ï¼Œæ­¤å¤–ä¸‹ä¸€å¸§è°ƒç”¨ä¹Ÿæ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°**\n\n### æ€»ç»“\nå¯¹äº**ResizeObserver loop completed with undelivered notifications.**è¿™ä¸ªé—®é¢˜ï¼Œæœ¬è´¨ä¸Šæ˜¯`ResizeObserverå›è°ƒå‡½æ•°`æ‰§è¡Œçš„ä¸­åœ¨åŒä¸€æ¬¡ç»˜åˆ¶å¼•å‘äº†è‡ªèº«å¤§å°æ”¹å˜å¯¼è‡´çš„ï¼ŒæŒ‰ç…§MDNçš„è§£é‡Šï¼Œæ˜¯å¾ªç¯ä¾èµ–å¯¼è‡´çš„æ— é™å¾ªç¯åªä¼šåœ¨æ¯æ¬¡è¿­ä»£æœŸé—´å¤„ç†DOMä¸­æ›´æ·±çš„å…ƒç´ çš„æ–¹å¼è§£å†³ï¼Œå¹¶ä¸”æ¨é€è¿™ä¸ªerrorä¿¡æ¯ã€‚åœ¨ä¸å¯¹é¡¹ç›®å›è°ƒå‡½æ•°è¿›è¡Œå¤§ä¿®æ”¹ä¹‹å‰ï¼Œä¸ºäº†ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨**requestAnimationFrame**ä»£æ›¿**setTimeout**ä¾¿å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ \n\n## <span id=\"title_2\" />2.clientHeight & getBoundingClientRect\næœ‰resizeæ“ä½œçš„ç»„ä»¶æœ¬è´¨ä¸Šç”¨äºæˆªå±ï¼Œéœ€è¦åŒæ—¶è·å–å…ƒç´ çš„ä½ç½®ä»¥åŠå®½é«˜ï¼Œç”±äºä½¿ç”¨äº†**transform: scale**ï¼Œæ‰€ä»¥ä½¿ç”¨äº†el.getBoundingClientRectè·å–å…ƒç´ å½“å‰å¤§å°å’Œä½ç½®ã€‚\nå½“æˆªå›¾å¼€å§‹åä¼šä½¿ç”¨eelctronæ–°å¼€ä¸€ä¸ªçª—å£è¿›è¡Œæ“ä½œï¼Œä½¿ç”¨getBoundingClientRectè·å–çš„é«˜åº¦æ•°æ®ï¼Œåœ¨é«˜åº¦ä¸Šåˆ†å‰²å›¾ç‰‡æˆå¤šä¸ªå°å›¾æˆªå›¾ä»¥ä¿è¯æ¸…æ™°åº¦ï¼Œä½†æ˜¯åœ¨æœ€ç»ˆæ‹¼æ¥æ—¶æ€»æ˜¯å‡ºç°å¯¹ä¸ä¸Šçš„é—®é¢˜ã€‚æŸ¥è¯¢apiåå‘ç°é—®é¢˜ï¼š\n#### é—®é¢˜å¤ç°\n##### 1.getBoundingClientRect\nè¿™ä¸ªapiè·å–çš„æ˜¯ä¸€ä¸ª**DOMRect**å¯¹è±¡ï¼Œæ‹¥æœ‰å¤šä¸ªå±æ€§ï¼šæ°´å¹³å‚ç›´åæ ‡x/yï¼ŒçŸ©å½¢å®½é«˜width/heightï¼ŒçŸ©å½¢ä¸Šå³ä¸‹å·¦åæ ‡top/rightç­‰ï¼Œæ­¤å¤–ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªä¸è§„åˆ™å›¾å½¢ä¾‹å¦‚åœ†å½¢ï¼Œä»ç„¶è·å¾—å¯¹åº”æœ€å°çš„çŸ©å½¢çš„å±æ€§ï¼ˆps.å¦‚æœéœ€è¦æ–‡å­—ç¯ç»•åœ†å½¢å¯ä»¥ä½¿ç”¨**shape-outside**è¿™ä¸ªcsså±æ€§ï¼‰ã€‚**DOMRect**å¯¹è±¡çš„å„ä¸ªå±æ€§æ ¹æ®å®é™…æ˜¾ç¤ºçš„æ•ˆæœï¼Œå³**scale**ä¼šå½±å“æœ€ç»ˆçš„æ•°æ®ï¼Œå¹¶ä¸”è¿™ä¸ªå±æ€§æ˜¯æœ‰å°æ•°çš„ã€‚\n##### 2.offsetHeight/offsetWidth & clientHeight/clientWidth\nè¿™ä¸¤ä¸ªå±æ€§å¯ä»¥è·å–å…ƒç´ çš„å®é™…å¤§å°ï¼Œæ˜¯**scale**ä¸ç”Ÿæ•ˆçš„æ—¶å€™çš„å¤§å°ï¼Œæˆ–è€…è¯´æ˜¯**scale**ä¸º1æ—¶å€™çš„å¤§å°ã€‚\noffsetHeight/offsetWidthï¼Œè·å–äº†è¾¹æ¡†å†…è¾¹è·ä»¥åŠ**æ»šåŠ¨æ¡**çš„å®½é«˜ï¼Œæ˜¯æ ‡å¿—ä¸€ä¸ªå…ƒç´ å®é™…å ç”¨é¡µé¢ç©ºé—´ï¼›clientHeight/clientWidthåªåŒ…å«äº†å†…è¾¹è·ï¼Œæ˜¯å…ƒç´ å†…å®¹å®½é«˜æˆ–è€…å«å¯è§å®½é«˜ï¼Œä»–ä»¬è·å–çš„å±æ€§è¿”å›å€¼é€šå¸¸æ˜¯æ•´æ•°ã€‚\n\n#### æ€»ç»“\nç”±äºè®¡ç®—åˆ‡å‰²ä½ç½®ä½¿ç”¨çš„å¸¦å°æ•°çš„æ•°æ®ï¼Œä½†å®é™…æˆªå›¾æ‹¼æ¥æ—¶æ²¡æœ‰ï¼Œå¯¼è‡´äº†æ“ä½œç•Œé¢çš„å›¾ç‰‡æ¯”ä¾‹å’Œæˆªå›¾çª—å£çš„å›¾ç‰‡æ¯”ä¾‹ä¸åŒï¼Œè™½ç„¶å·®è·ä»…æœ‰å‡ ä¸ªpxï¼Œä½†æ˜¯åœ¨æ‹¼æ¥å›¾ç‰‡çš„æ“ä½œä¸­å½±å“å¾ˆå¤§ã€‚\n","tags":["ResizeObserver"]},{"title":"Typescript Study Notes","url":"/2024/02/20/Typescript Study Notes/","content":"## Catalouge\n  - [Preface](#preface)\n  - [Union type and Intersection type](#utait)\n    - [Keyof Union type](#utait_1)\n    - [Satisfies](#utait_2)\n    - [Ergodic union type](#utait_3)\n  - [Conditional types](#ct)\n    - [Keyword `infer`](#ct_1)\n    - [Compare diffirent types](#ct_2)\n    - [Distribute union types](#ct_3)\n<!-- more -->\n\n\n## <span id=\"preface\" />Preface\nI have used Typescript in development for about one and half year, but a systematic learning is never happened during my front-end work. Luckly, I got a period time between my last job and my next job, so it's time to make deep study of TypescriptğŸ‰!\n\n## <span id=\"utait\" />Union type and Intersection type\n#### <span id=\"utait_1\" />1. Keyof union type\nUnion type is a way to combine types, formed from two or more other types. So what about the keys of a union type?\n``` Typescript\ntype UnionInterface = { name: string } | { name: string; age: number; sex: number }\n\nconst people1: UnionInterface = { name: 'JACK' } // âˆš\nconst people2: UnionInterface = { name: 'JACK', age: 23 } // âˆš\nconst people3: UnionInterface = { age: 23 } // Ã—\n```\nThe example above confused me a lot at first. But an explain from `The Typescript Handbook` may help us understand the loogic of it.\n> Only the intersection of those facts applies to the union of the sets themselves. For example, if we had a room of tall people wearing hats, and another room of Spanish speakers wearing hats, after combining those rooms, the only thing we know about every person is that they must be wearing a hat.\n\nThe key **`name`** can be interpreted as `a safety key` which means every member of the union type **`UnionInterface`** must have it. Then a conclusion come naturally that `keyof`**`UnionInterface`** expected to be **`name`**, or a union type seems has some properties of an intersection type.\n\n#### <span id=\"utait_2\" />2. Satisfies\nProviding a value matching a union type is pretty easy: just provide a type that matching any memebers of the union type. However, somtimes we want to restrict the type of the value without rewrite a union type. `Typescript 4.9` give a keyword named **`satisfies`**.\n``` Typescript\ntype SatisfiesType = {\n  name: string\n  hobby: 'soccer' | 'tennis' | 'swimming' | 'running'\n}\n\nconst Jack: SatisfiesType = {\n  name: 'Jack',\n  hobby: 'soccer' | 'tennis',\n}\n\nconst Mary = {\n  name: 'Mary',\n  hobby: 'swimming' | 'running',\n} satisfies SatisfiesType\n\n// do some reassignment\nJack.hobby = 'swimming' // âˆš\nMary.hobby = 'tennis' // Ã—\n```\nThis keyword `satisfies` can make prediction of the type with an instance. It provide type declaration and type infers at the same timeğŸ‰! But is there any way that can restrict the range of type without an instance. Or in other words, I need a type which can predict other types according to the attribute that entered by myself.\n\n#### <span id=\"utait_3\" />3. Ergodic union type\nIn the section above, there is still a problem of how to predict other attributes' types according to the attribute that entered by myself. For example\n``` Typescript\ntype Hobbies = {\n  Jack: 'tennis' | 'soccer'\n  Mary: 'running' | 'swimming'\n}\n\nconst person: /** some type */ = {\n  name: 'Jack'\n  hobbies: // expected to be 'tennis' | 'soccer'\n}\n```\nIt easy to make it when we declare a union type: \n``` Typescript\ntype Person = {\n  name: 'Jack'\n  hobby: 'tennis' | 'soccer'\n} | {\n  name: 'Mary'\n  hobby: 'running' | 'swimming'\n}\n```\nThis method can work when there is not many members of the union type, and it seems so unpleasant when we have to maitain the type. Therefore we need a more generic method to declare the union type, and a tenary expression: `T extends T ?` may help us a lot.\n``` Typescript\ntype Person<T extends keyof Hobbies = keyof Hobbies> = T extends T\n  ? {\n      name: T\n      hobby: Hobbies[T]\n    }\n  : never\n\nconst person: Person = {\n  name: 'Jack',\n  hobby: // ('tennis' | 'soccer') is inferred\n}\n```\nWith type similar to `Person`, it will be super easy for us to get an expect value when we do some coding.\n![Auto predictğŸ‰ğŸ‰ğŸ‰](../img/blog/typescript_1.png)\n\n## <span id=\"ct\" />Conditional types\nConditional types are used to describe the relation between the types of inputs and outputs. As I mentioned above, I used `T extends T ? ` to destribute a union type. In fact this kind of expression which is like a tenary expression has a name `Conditional Types`\n\n#### <span id=\"ct_1\" />Keyword `infer`\nThe keyword `infer` is an amazing design. As it's name shows, `infer` is used to \"infer\" a type from another type.\n``` Typescript\ntype InferExample = { name: string; age: number } extends { name: infer A } ? A : never // string\n```\nIn my opinion, `infer` is just like `x` in equtions. People can use this keyword to do many operations.\n``` Typescript\ntype SliceStr<T extends string> = 'Typescript is great' extends `${infer A} is${string}` ? A : never // Tpescript \ntype DivideArray<T extends any[]> = ['a', 'b', 'c'] extends [infer A, ...infer Rest] ? A : never // 'a'\n\n// and it is valid for functions\ntype ReturnFunction<T extends (...args: any) => any> = T extends (...args: any[]) => infer U ? U : any\nconst testFn = (a: number) => a\ntype ReturnTest = ReturnFunction<typeof testFn> // number\n``` \n\n#### <span id=\"ct_2\" />Compare diffirent types\nIn `conditional types`, the type on the left of the **extends** can assignable to the one on the right will decide the type you get comes from the first branch or the second one. But there is some peorblem I met when I compared two types in conditional types.\n\ntype `never` is assignable to everything. And nothing is assignable to `never`. When some type you decalre is wrong and it will return type `never`\n``` Typescript\ntype GetNever = string & number // never\n```\ntype `unknown` is similar to the type `any`, but when we use `unknown` means that ther definitelty be a type except `never`. Therefore use `unknown` instead of `any` could be better when we migrate from `Javascript` to `Typescript`.Except afore-mentioned examples, the specific relationships between abstract types.\n![Abstract types relationships](../img/blog/typescript_2.png)\n\n#### <span id=\"ct_3\" />Distribute union types\nIn the previous article, I used conditional type `T extends T ?` to distribute union types. In fact, sometime we do not need distributing union types, and `[]` will help us avoid this behavior.\n``` Typescript\ntype UnionType = string | number\n\ntype UnionToArray<T> = T extends unknown ? T[] : never\ntype UnknownArray = UnionToArray<UnionType> // expect string[] | number[]\n\n// with \"[]\"\ntype UnionToArray<T> = [T] extends [unknown] ? T[] : never\ntype UnknownArray = UnionToArray<UnionType> // expect (string | number)[]\n```\n### To be continue ... ...","tags":["Typescript"]},{"title":"NuxtJs-2.x Memory Leak","url":"/2024/01/20/NuxtJs Memory Leak/","content":" - [Problem](#Problem)\n - [Memory Leak ](#Memory)\n - [Solution](#Solution)\n - [Conclusion](#Conclusion)\n - [Reference](#Reference)\n\n<!-- more -->\n\n## <span id=\"Problem\" />Problem\nDuring my previous job, I met a problem where the server memory useage is always increase very quickly, and it will reboot automatically when memory useage reached a threshold. At first, we speculated that meybe it is due to the high visit volume during peak time, and the solution is ...emmm ADD MORE SERVER! (â”“(Â Â´âˆ€`Â )â”)\nAnd it's easy to predict what will happen next: our website will run slower and slower. At last, we decide to check whether we encountered memory leak.\n\n## <span id=\"Memory\" />Memory Leak \nFirst of all, I have to figure it out if the memory leak has really happpened. Our production is a server side render website which we used NuxtJs-2.X to make it. So as the memory leak occurs on the server side, we can't simply use the **`Memory`** tool from Chrome Dev-Tools to take a snapshot of the heap size. Fortunately I discovered a solution from other developer's articles.\n### 1. How to take server side memory snapshot \nThere is a tool that chrome give to us to inspect the devices. Just type **`chrome://inspect/#devices`** into the address bar of chrome broswer, and then you will see something like this:\n\n![chrome://inspect/#devices](../img/blog/memory_leak_1.png)\nSet your server side local address in **`Configure`** of **` Discover network targets`**, and then it will work when the service of server-side is running.\n#### 2. Set inspect port before build\nAfter kowning how to inpect server-side memory useage, there is another problem with how to run our server on a specific port. And Node give us a solution which named `v8 Inspector Protocol`. Add the following code to `package.json`, and run it.\n\n``` bash\n$ \"inspect:start\": \"node --inspect=9001 node_modules/nuxt/bin/nuxt start --modern=server\"\n```\n\n#### 3. Take server-side heap snapshots\nBefore excuting this command, you need build your project first. When the project is running normally, visit `chrome://inspect/#devices`, and choose the `Memory` panel. Take heap snapshots twice and compare them.\n\n![memory snapshot comparation](../img/blog/memory_leak_2.png)\n\nIf you need send lot of concurrent requests when take heap snapshot, try [loadtest](https://github.com/alexfernandez/loadtest), it helps me a lot.\n\n## <span id=\"Solution\" />Solution\nAfter check more code, I found an `eventbus` that may be the ultimate reason.\n\n``` bash\ncreated () {\n  eventHub.$on(EventName, () => {\n    this.loading = true \"//this is use in a component which we regist with vue.component\"\n  })\n},\n```\n\nThough we use `$off` to cancel it in the hook `unmounted`, but but according to the reference of nuxtjs, there are only two lifecycle hooks be called both, from client-side and server-side: `beforeCreate` and `created`. \n\n``` bash\ncreated () {\n  if(process.env === 'client'){ \"//add a enviroment judgement\" \n    eventHub.$on(EventName, () => {\n      this.loading = true \n    })\n  }\n},\n```\nAfter add a judgement about enviroment, I took another two snapshot and the problem seems be solved.\n\n## <span id=\"Conclusion\" />Conclusion\nThe content above describes the process of how I identify the server-side memory leak problem and solve it. In fact, during the time when I was looking for information in the Nuxtjs document, I found that `vue.use` and `vue.component` may cause memory leak, but I'm not sure if it is related to this project. I can't go into this problem due to my dismissal from my last job, I tried to reproducing the issue with nuxtjs-3.x, but it didn't go as planned. Maybe next time when I meet something simillar, I will update this blog!ğŸ˜Š\n\n## <span id=\"Reference\" />Reference\nhttps://medium.com/le-collectionist/solving-server-side-memory-leaks-on-nuxt-js-ecd6b16b54a0\nhttps://stackoverflow.com/questions/66831561/nuxt-add-global-plugins-memory-leakage-issue\nhttps://github.com/alexfernandez/loadtest","tags":["NuxtJs"]}]